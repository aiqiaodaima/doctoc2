<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>参会资助申请</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.2/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.0/css/jquery-weui.min.css">
    <!-- <link rel="stylesheet" href="../css/index.css"> -->
    <link rel="stylesheet" href="../css/ydui.css">
    <!-- 通用样式 -->
    <link rel="stylesheet" href="../css/public.css">
    <link rel="stylesheet" href="../css/three-pagelearning1.css">
    <link rel="stylesheet" href="../css/four-taskapply.css">
    <style>
        .weui-cells {
            margin-bottom: 5px;
        }

        .weui-cell_select .weui-cell__bd:after {
            width: 10px;
            height: 10px;
        }

        .weui-cellslast {
            margin-bottom: 0;
        }

        .img_content {
            width: 100px;
            height: 100px;
            display: none;
        }

        .special_item {
            padding: 0 1rem;
        }
    </style>
</head>

<body ontouchstart>
    <div class="page__bd">
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell weui-cell_select weui-cell_select-after">
                <div class="weui-cell__hd">
                    <label for="" class="weui-label">会议身份</label>
                </div>
                <div class="special_item">
                    参会
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">会议名称</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input name" type="text" placeholder="请输入会议名称">
                </div>
            </div>
            <div class="weui-cell weui-cell_select weui-cell_select-after">
                <div class="weui-cell__hd">
                    <label for="select2" class="weui-label label_change">会议性质</label>
                </div>
                <div class="weui-cell__bd">
                    <select class="weui-select selector_12 nature" name="select2">
                        <option value="01">请选择</option>
                        <option value="全国大型">全国大型</option>
                        <option value="受邀讲学">受邀讲学</option>
                        <option value="访问学者">访问学者</option>
                        <option value="区域大型">区域大型</option>
                        <option value="系统培训">系统培训</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">预算金额</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input budgetMoney" type="number" pattern="[0-9]*" placeholder="请输入预算金额">
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">已获资助</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input gainMoney" type="number" pattern="[0-9]*" placeholder="请输入已获取资助金额">
                </div>
            </div>
        </div>
        <div class="weui-cells weui-cells_form weui-cellslast">
            <div class="weui-cell selector_1 moving">
                <div class="weui-cell__hd">
                    <label class="weui-label">会议开始时间</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input startTime" type="text" id='datetime-picker' placeholder="请选择" />
                </div>
            </div>
            <div class="weui-cell selector_1 moving">
                <div class="weui-cell__hd">
                    <label class="weui-label">会议结束时间</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input endTime" type="text" id='datetime-picker2' placeholder="请选择" />
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">申请资助</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input applyMoney" type="text" placeholder="请输入申请资助">
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">资金用途说明</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input explain" placeholder="请输入资金用途说明">
                </div>
            </div>
            <div class="weui-cell weui-cell_select weui-cell_select-after">
                <div class="weui-cell__hd">
                    <label for="" class="weui-label">邀请函上传</label>
                </div>
                <div class="weui-cell__bd" style="padding-right: 2.68rem;text-align: right;">
                    <label class="" for="files">拍照上传</label>
                    <form>
                        <input type="file" accept="image/png, image/jpeg, image/gif, image/jpg" id="files" style="position:absolute;clip:rect(0 0 0 0);">
                    </form>
                </div>
            </div>
            <div class="option_img weui-cell">
                <ul></ul>
            </div>
        </div>
        <div class="btn_top"></div>
        <div class="item_btn">
            <!-- <a href="audit.html">提交资助申请</a> -->
            <a href="javascript:void(0)">提交资助申请</a>
        </div>
    </div>
</body>
<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/jquery-weui.min.js"></script>
<script src="http://gosspublic.alicdn.com/aliyun-oss-sdk-4.4.4.min.js"></script>
<script src="../js/public.js"></script>
<script>
    $(function () {
        $("#datetime-picker").datetimePicker({
            times: function () {
                return [
                ];
            },
            onChange: function (picker, values, displayValues) {
                console.log(values);
            }
        });
        $("#datetime-picker2").datetimePicker({
            times: function () {
                return [
                ];
            },
            onChange: function (picker, values, displayValues) {
                console.log(values);
            }
        });
        var nature, budgetMoney, gainMoney, startTime, endTime, applyMoney, explain;
        var arr = [];
        $('.weui-select').on('change', function () {
            $(this).css('color', '#666');
        })
        $('.name').on('change', function () {
            name = $(this).val()
        })
        $('.nature').on('change', function () {
            nature = $(this).val()
        })
        $('.budgetMoney').on('change', function () {
            budgetMoney = $(this).val()
        })
        $('.gainMoney').on('change', function () {
            gainMoney = $(this).val()
        })
        $('.startTime').on('change', function () {
            startTime = $(this).val()
        })
        $('.endTime').on('change', function () {
            endTime = $(this).val()
        })
        $('.applyMoney').on('change', function () {
            applyMoney = $(this).val()
        })
        $('.explain').on('change', function () {
            explain = $(this).val()
        })

        $('#files').on('change', function () {

            if (!$(this).val()) {
                $.alert('没有上传文件');
                return;
            }
            $('.option_img').css({ display: 'block' })
            const file = this.files;
            // const file = $(this).prop('files');
            const size = file.size;

            console.log(file)
            // 文件大小限制
            if (size >= 1 * 1024 * 1024) {
                $.alert('文件大于1兆不行!');
                return false;
            }
            // 文件类型限制
            // if (file.type !== 'image/jpeg' && file.type !== 'image/png' && file.type !== 'image/gif') {
            //     alert('不是有效的图片文件!');
            //     return;
            // }
            // 获取base64
            var reader = new FileReader();
            const img = new Image();
            reader.readAsDataURL(file[0])
            reader.onload = function (e) {
                console.log(e)
                let data = e.target.result;   // 'data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...}' 
                console.log(data);
                img.src = e.target.result;
                // 缩放图片需要的canvas
                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                let el = `<li class = "li_img"><img src=${data} alt=""></li>`
                $('.option_img ul').append(el)
                // 上传OSS
                function toBlob(urlData, fileType) {
                    var bytes = window.atob(urlData),
                        n = bytes.length,
                        u8arr = new Uint8Array(n);
                    while (n--) {
                        u8arr[n] = bytes.charCodeAt(n);
                    }
                    return new Blob([u8arr], { type: fileType });
                }
                var dataUrl = e.target.result;
                var base64 = dataUrl.split(',')[1];
                var fileType = dataUrl.split(';')[0].split(':')[1];
                var blob = toBlob(base64, fileType);
                var reader = new FileReader();
                reader.readAsArrayBuffer(blob);
                reader.onload = function (event) {

                    // 配置
                    var client = new OSS.Wrapper({
                        region: 'oss-cn-shenzhen',
                        accessKeyId: 'LTAIFSHcWupSdU9C',
                        accessKeySecret: 'HefnQDo4RGM9NXpWMACA62K9UAs1MR',
                        bucket: 'imuts'
                    });

                    // 文件名
                    var date = new Date();
                    var time = '' + date.getFullYear() + date.getMonth() + 1 + date.getDate();
                    var storeAs = 'doctorGroup/doctorFile/' + date.getTime() + '.' + blob.type.split('/')[1];

                    // arrayBuffer转Buffer
                    var buffer = new OSS.Buffer(event.target.result);

                    // 上传
                    client.put(storeAs, buffer).then(function (result) {
                        console.log(result)
                        let img_url = result.name;
                        arr.push(img_url);
                        // console.log(arr)
                        localStorage.setItem('img_url', arr)
                        return arr;
                    }).catch(function (err) {
                        console.log(err);
                    });
                }

            };
            // console.log(file);
        })
        let url = Public.url()
        $('.item_btn').on('click', () => {
            if(localStorage.getItem('img_url') == ''){
                $.alert('请先上传邀请函');
                return;
            }
            // var nature,budgetMoney,gainMoney,startTime,endTime,applyMoney,explain;
            if (nature == undefined || budgetMoney == undefined || gainMoney == undefined || startTime == undefined || endTime == undefined || applyMoney == undefined || explain == undefined) {
                $.alert('请先填写资料')
            } else {
                // arr = ["doctorGroup/doctorFile/1533294399198.png", "doctorGroup/doctorFile/1533294403695.png"]
                var dmpfList = [];
                for (var i in arr){
                    dmpfList[i] = {
                        name : arr[i].split("/")[2],
                        url : arr[i]
                    }
                }
                

                let pdList = [{
                    "dmpm":
                    {
                        "dtrId": localStorage.getItem('userId'),
                        "name": name,
                        "nature": nature,
                        "budgetMoney": budgetMoney,
                        "gainMoney": gainMoney,
                        "startTime": startTime,
                        "endTime": endTime,
                        "applyMoney": applyMoney,
                        "explain": explain,
                    }
                // }, {
                //     "dmpfList":
                //         [{
                //             "name": localStorage.getItem('img_url').split("/")[2],
                //             "url": localStorage.getItem('img_url')
                //         }]
                }];
                pdList.push({"dmpfList":dmpfList})
                console.log(JSON.stringify(pdList))
                let p = new Promise((resolve, reject) => {
                    $.ajax({
                        url: `${url}/metting/insertOrUpdateDmpm`,
                        type: 'POST',
                        contentType: "application/json;charset=UTF-8",
                        dataType: 'json',
                        traditional: true,
                        data: JSON.stringify(pdList),
                        success(res) {
                            console.log(res);
                            localStorage.setItem('img_url','')
                            resolve(res)
                        },
                        error() {
                            reject(res)
                            $.alert('请先填写资料')
                        }
                    })
                })
                p.then(res => {
                    window.location = 'audit.html'
                }, res => {
                    $.alert('请先填写资料')
                })
            }
        })
    });
</script>

</html>